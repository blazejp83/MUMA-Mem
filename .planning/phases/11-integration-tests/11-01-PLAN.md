---
phase: 11-integration-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/__tests__/mock-api.ts
  - src/__tests__/registration.test.ts
  - src/__tests__/tool-factory.test.ts
autonomous: true
---

<objective>
Test that registerPlugin correctly wires up all OpenClaw integration points (hooks, tools, CLI) and that the tool factory produces correctly shaped tools.

Purpose: Verify the plugin registration contract — all 9 hooks registered, tool factory registered with correct names, CLI registrar registered.
Output: Mock API helper + 2 test files covering registration and tool shape.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/plugin.ts
@src/tools/index.ts
@src/cli/openclaw.ts
@src/types/openclaw.ts
@src/utils/__tests__/deriveUserId.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mock API helper and test registerPlugin registration</name>
  <files>src/__tests__/mock-api.ts, src/__tests__/registration.test.ts</files>
  <action>
Create `src/__tests__/mock-api.ts` — a reusable factory that builds a mock OpenClawPluginApi:
- `createMockApi()` returns an object satisfying the OpenClawPluginApi type
- `api.on(hookName, handler)` captures handlers into a `Map<string, Function>` exposed as `api._hooks`
- `api.registerTool(factoryOrTool, opts)` captures into `api._tools` array (store the factory/tool and opts)
- `api.registerCli(registrar, opts)` captures into `api._cli` array (store registrar and opts)
- `api.logger` has `info`, `warn`, `error` as vi.fn() stubs
- `api.pluginConfig` defaults to `{}` (triggers MumaConfigSchema defaults)
- `api.resolvePath` returns the input string unchanged
- `api.id`, `api.name`, `api.source` set to test values

Create `src/__tests__/registration.test.ts`:
- Import `registerPlugin` from `../plugin.js` and `createMockApi` from `./mock-api.js`
- vi.mock all heavy dependencies that gateway_start/hooks import (these are NOT called during registerPlugin, but the module imports them). Mock: `../store/factory.js`, `../embedding/factory.js`, `../embedding/validation.js`, `../llm/factory.js`, `../pipeline/write.js`, `../pipeline/read.js`, `../sync/index.js`, `../access/index.js`, `../daemon/index.js`, `../memory/index.js`
- Test "registers all 9 hooks": call registerPlugin(mockApi), verify mockApi._hooks has keys: gateway_start, session_start, before_agent_start, session_end, before_compaction, before_reset, message_received, after_tool_call, gateway_stop
- Test "registers tool factory": verify mockApi._tools.length === 1 and opts.names contains all 10 tool names
- Test "registers CLI": verify mockApi._cli.length === 1 and opts.commands contains "memory"
- Test "logs registration messages": verify api.logger.info was called with messages containing "tools registered" and "CLI commands registered"
  </action>
  <verify>pnpm test -- --run src/__tests__/registration.test.ts passes all tests</verify>
  <done>Mock API helper created. Registration test verifies 9 hooks, 1 tool factory (10 names), 1 CLI registrar, and log messages.</done>
</task>

<task type="auto">
  <name>Task 2: Test tool factory returns correctly shaped tools</name>
  <files>src/__tests__/tool-factory.test.ts</files>
  <action>
Create `src/__tests__/tool-factory.test.ts`:
- Import `registerTools` from `../tools/index.js` and `createMockApi` from `./mock-api.js`
- vi.mock all dependencies that tools/index.ts imports from plugin.js (getStore, getWorkingMemory, etc.) — these are called at tool execute time, not at registration time
- vi.mock `../pipeline/write.js` and `../pipeline/read.js`
- vi.mock `../consolidation/consolidate.js` and `../consolidation/distill.js`
- vi.mock `../access/index.js` (resolveAgentProfile, canAgentSeeNote)

Test suite:
- "tool factory registration": call registerTools(mockApi), verify api._tools has 1 entry (the factory function)
- "factory produces 10 tools": extract the factory from api._tools[0], call it with a mock OpenClawPluginToolContext `{ sessionKey: "telegram:123:agent1", agentId: "agent1" }`, verify it returns an array of 10 AgentTool objects
- "each tool has required fields": for each tool, verify it has: name (string), label (string), description (string), parameters (object with type: "object"), execute (function)
- "tool names match expected set": verify the 10 names are exactly: memory_write, memory_query, memory_forget, memory_pin, memory_set_visibility, memory_get_context, memory_stats, memory_link, memory_search_agents, memory_consolidate
- "factory captures userId from sessionKey": call factory with sessionKey "telegram:123:agent1", then verify the factory closure captured userId "telegram:123" by invoking memory_write's execute with mock content and checking the write() mock was called with userId "telegram:123"
- "factory captures agentId from context": same approach — verify write() mock receives agentId "agent1"
- "factory defaults agentId to 'unknown'": call factory with `{ sessionKey: "test:user" }` (no agentId), invoke a tool, verify agentId is "unknown"
  </action>
  <verify>pnpm test -- --run src/__tests__/tool-factory.test.ts passes all tests</verify>
  <done>Tool factory tests verify: 10 tools produced, correct names/labels/signatures, userId derivation from sessionKey, agentId capture.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm test -- --run src/__tests__/registration.test.ts` passes
- [ ] `pnpm test -- --run src/__tests__/tool-factory.test.ts` passes
- [ ] `pnpm run typecheck` passes (no TS errors in test files)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Mock API helper is reusable by Plan 02
- Registration test verifies all 9 hooks, tool factory (10 names), CLI registrar
- Tool factory test verifies shape, naming, userId/agentId capture
  </success_criteria>

<output>
After completion, create `.planning/phases/11-integration-tests/11-01-SUMMARY.md`
</output>
