---
phase: 05-background-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/consolidation/distill.ts
  - src/daemon/scheduler.ts
  - src/daemon/index.ts
  - src/plugin.ts
  - src/tools/index.ts
  - src/index.ts
autonomous: true
---

<objective>
Create MEMORY.md distillation from consolidated knowledge and wire daily consolidation into the plugin lifecycle.

Purpose: MEMORY.md provides a human-readable, always-current summary of an agent's knowledge — useful for context injection and human inspection. The daily scheduler automates consolidation so the memory system self-maintains.
Output: MEMORY.md generation from consolidated summaries, daily consolidation scheduler, working memory.consolidate tool.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Genuinely needed — uses consolidation functions and sweep daemon
@.planning/phases/05-background-intelligence/05-01-SUMMARY.md
@.planning/phases/05-background-intelligence/05-02-SUMMARY.md

@src/consolidation/index.ts
@src/daemon/index.ts
@src/plugin.ts
@src/tools/index.ts
@src/config.ts
@src/types/note.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MEMORY.md distillation module</name>
  <files>src/consolidation/distill.ts, src/consolidation/index.ts</files>
  <action>
  **Create src/consolidation/distill.ts:**

  Export `distillMemoryMd(userId: string, store: MemoryStore, llm: LLMProvider): Promise<string>`

  Algorithm:
  1. Fetch all notes for user sorted by activation descending: `store.listByUser(userId, { limit: 200 })`
  2. Separate into categories:
     - High activation (> 2.0): "Active Knowledge"
     - Medium activation (0 to 2.0): "Background Knowledge"
     - Consolidated summaries (tag includes "consolidated"): "Consolidated Insights"
  3. Send high-activation notes + consolidated summaries to LLM with prompt:
     - "Given these memories, produce a concise MEMORY.md that captures the most important knowledge about this user. Organize by topic. Use markdown headers and bullet points. Keep it under 200 lines. Focus on durable facts, preferences, and decisions — omit transient or session-specific details."
  4. Return the generated markdown string

  Export `writeMemoryMdFile(content: string, userId: string, baseDir?: string): Promise<string>`
  - Write to `{baseDir}/{userId}/MEMORY.md` (default baseDir: `~/clawd/memory/`)
  - Create directory if it doesn't exist
  - Return the file path
  - Use `node:fs/promises` and `node:path`

  **Update src/consolidation/index.ts:**
  Add re-exports for distill module.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>MEMORY.md distillation generates organized knowledge summary from consolidated memories and writes to filesystem</done>
</task>

<task type="auto">
  <name>Task 2: Wire daily consolidation scheduler and update memory.consolidate tool</name>
  <files>src/daemon/scheduler.ts, src/daemon/index.ts, src/plugin.ts, src/tools/index.ts, src/index.ts</files>
  <action>
  **Create src/daemon/scheduler.ts:**

  Export `startConsolidationScheduler(store, embedding, llm, config, logger?): () => void`
  - Runs daily consolidation using `setInterval` with 24h interval (86_400_000 ms)
  - On each tick:
    1. Get all unique user IDs (use `store.listAllNotes` in pages, collect unique user_ids into Set)
    2. For each user: call `consolidate(userId, store, embedding, llm)`
    3. For each user: call `distillMemoryMd(userId, store, llm)` then `writeMemoryMdFile(content, userId)`
    4. Log summary of results
  - Does NOT run immediately on start (first run after 24h; the sweep handles immediate needs)
  - Returns cleanup function that clears the interval
  - Catch and log errors for individual users (don't let one user's failure stop others)

  **Update src/daemon/index.ts:**
  - Re-export `startConsolidationScheduler`
  - Re-export consolidation modules needed externally

  **Update src/plugin.ts:**
  - Import `startConsolidationScheduler`
  - In `gateway_start`, after sweep scheduler, start consolidation scheduler (only if LLM is configured)
  - Store cleanup function in module-level state (e.g., `let consolidationCleanup`)
  - In `gateway_stop`, call cleanup
  - Log: `[muma-mem] Consolidation: daily`

  **Update src/tools/index.ts — replace memory.consolidate placeholder:**
  - Import `consolidate` and `distillMemoryMd` and `writeMemoryMdFile`
  - Replace the placeholder implementation with actual logic:
    1. Run `consolidate(context.userId, store, embedding, llm)`
    2. Run `distillMemoryMd(context.userId, store, llm)` then `writeMemoryMdFile(content, context.userId)`
    3. Return the ConsolidationReport + MEMORY.md path
  - Guard: Return error if LLM provider not configured (consolidation requires LLM)

  **Update src/index.ts:**
  - Add consolidation exports: `consolidate`, `distillMemoryMd`, `ConsolidationReport`, `MemoryConflict`, `ConflictType`
  </action>
  <verify>npm run typecheck passes; npm run build succeeds; memory.consolidate tool no longer returns placeholder response</verify>
  <done>Daily consolidation runs automatically, MEMORY.md gets regenerated, memory.consolidate tool works for on-demand consolidation, all types exported</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] `npm run build` succeeds
- [ ] MEMORY.md distillation generates organized markdown
- [ ] Daily scheduler integrates into plugin lifecycle
- [ ] memory.consolidate tool triggers full pipeline
- [ ] All new types exported from package root
</verification>

<success_criteria>
- All tasks completed
- CONSOL-04: MEMORY.md distilled from consolidated knowledge
- Daily consolidation runs automatically when LLM configured
- memory.consolidate tool provides on-demand consolidation
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/05-background-intelligence/05-03-SUMMARY.md`
</output>
